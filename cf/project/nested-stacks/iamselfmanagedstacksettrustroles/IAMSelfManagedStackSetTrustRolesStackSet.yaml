AWSTemplateFormatVersion: '2010-09-09'
Description: IAM Self-Managed StackSet Trust Roles for the DevSecOps Project

Parameters:
  #Application Generic Parameters
  BuildGuid:
    Type: String
    Description: Unique Id used in build to force CloudFormation StackSet to update
  ProjectFriendlyName:
    Type: String
    Description: Enter an friendly project name for Tagging
  ProjectResourcePrefix:
    Type: String
    Description: Enter a unique prefix for the project resources.
  EnvironmentType:
    Type: String
    AllowedValues:
      - prod
      - test
    Description: Enter destination environment type 
  EnvironmentFriendlyName:
    Type: String
    Description: Friendly environment name of project
  OrganizationalUnitIds:
    Type: String
    Description: Comma separated string of OrganizationalUnitIds to deploy stackset to
  DeploymentRegions:
    Type: String
    Description: Comma separated string of AWS Regions to deploy stackset to
  RetainStacksOnAccountRemoval:
    Type: String
    AllowedValues:
      - "true"
      - "false"
    Description: Friendly environment name of project
  #Project Specific Parameters >>
  ManagementAccountAWSCloudFormationStackSetAdministrationRoleArn:
    Type: String
    Description: Arn of the Management Account AWS AWSCloudFormationStackSetAdministrationRole
  ManagementAccountLambdaVPCStackSetInstanceExecutionRoleArn:
    Type: String
    Description: Arn of the Management Account LambdaVPCInstanceExecutionRole
  #<< Project Specific Parameters
    
Resources:

  IAMSelfManagedStackSetTrustRolesStackSet:
    Type: AWS::CloudFormation::StackSet
    Properties: 
      StackSetName: !Sub "${ProjectResourcePrefix}-iamsmssrolesstackset-${EnvironmentType}"
      TemplateURL: !Sub "https://${ProjectResourcePrefix}-main-artifacts-codebuild.s3.amazonaws.com/${BuildGuid}/IAMSelfManagedStackSetTrustRolesStack_output.yaml"
      AutoDeployment: 
        Enabled: true
        RetainStacksOnAccountRemoval: !Ref RetainStacksOnAccountRemoval
      Capabilities: 
        - 'CAPABILITY_IAM'
        - 'CAPABILITY_NAMED_IAM'
      Description: !Sub "Stack set for project ${ProjectResourcePrefix}"
      Parameters: 
        - ParameterKey: ProjectFriendlyName
          ParameterValue: !Ref ProjectFriendlyName
        - ParameterKey: ProjectResourcePrefix
          ParameterValue: !Ref ProjectResourcePrefix
        - ParameterKey: EnvironmentType
          ParameterValue: !Ref EnvironmentType
        - ParameterKey: EnvironmentFriendlyName
          ParameterValue: !Ref EnvironmentFriendlyName
        - ParameterKey: ManagementAccountAWSCloudFormationStackSetAdministrationRoleArn
          ParameterValue: !Ref ManagementAccountAWSCloudFormationStackSetAdministrationRoleArn
        - ParameterKey: ManagementAccountLambdaVPCStackSetInstanceExecutionRoleArn
          ParameterValue: !Ref ManagementAccountLambdaVPCStackSetInstanceExecutionRoleArn
      PermissionModel: SERVICE_MANAGED
      StackInstancesGroup: 
        - DeploymentTargets:
            OrganizationalUnitIds: 
              !Split [",", !Ref OrganizationalUnitIds]
          Regions: !Split [",", !Ref DeploymentRegions]
      OperationPreferences:
        # Stop if over 20% of stacks fail in any given region.
        FailureTolerancePercentage: 20
        MaxConcurrentPercentage: 40
        RegionConcurrencyType: PARALLEL
      Tags:
        - Key: Project
          Value: !Ref ProjectFriendlyName
        - Key: Purpose
          Value: Child account IAM self-managed StackSet roles for DevSecOps Project
        - Key: Environment
          Value: 
            !Ref EnvironmentFriendlyName